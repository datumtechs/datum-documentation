
# 数据可信交易及授权

### 元数据查看

用户可以先通过查看已发布的元数据确定原始数据情况，判断是否需要购买对应的Data Token; 用户可调用元数据查看API接口，在链上或数据服务平台上发起查询，此调用过程不需要鉴权。

**如何使用**

- 接口名称：getMetaData
- 参数说明

  | 名称             | 类型    | 说明                            | 是否必填 |
  | ---------------- | ------- | ------------------------------- | -------- |
  | contract_address | address | NFT合约地址                     | Y        |
  | chainId          | uint32  | 链id，默认为1，表示ethereum主网 | N        |
  | tokenid          | string  | NFT的id                         | Y        |

- 响应

  ```json
  {
  	"status": 200,
  	"result": {
  		"token_address": "0x8df91a59b8610990004987ac6ad8b6e70779ee97",
  		"token_id": "1",
  		"owner_of": "0x806164c929ad3a6f4bd70c2370b3ef36c64deaa8",
  		"contract_type": "ERC721",
  		"name": "datum",
  		"symbol": "FZAI1",
          "file_hash": "0x.....................",
          "storage_method": "hosting/Unmanaged",
          "permission_type": "ownership/use", 
  		"metadata": "{
          	"name": "datum", 
          	"description": "this is datum metadata", 
          	"data_size": 100, 
              "columns": 2, 
              "rows": 10, 
              "cols_desc": [
                  {"col_name": "col1", "col_desc": "this is col1 desc"},
                  {"col_name": "col2", "col_desc": "this is col2 desc"}
  			]
  		}"
  	},
  	"msg": "get MetaData success."
  }
  ```

- 示例

  ```shell
  curl --request POST \
       --url 'http://datumtechs.com/api/v2/$contract_address/getMetaData?chainId=$chainId&tokenid=$tokenid' \
       --header 'Accept: application/json' \
       --header 'Content-Type: application/json' \
       --header 'X-API-Key: test'
  ```


### 所有权转移

用户在确定需要某个数据资产后，与提供方达成数据资产交易买卖后，数据提供方可通过调用此API改变Data Token的所有权属性，将该Data Token转移给购买用户。获得所有权的用户可以凭该Token访问、查看、下载对应的原始数据。


**如何使用**

- 接口名称：transferOwnership

- 参数说明

  | 名称             | 类型    | 说明                            | 是否必填 |
  | ---------------- | ------- | ------------------------------- | -------- |
  | contract_address | address | NFT合约地址                     | Y        |
  | chainId          | uint32  | 链id，默认为1，表示ethereum主网 | N        |
  | tokenid          | string  | NFT的id                         | Y        |
  | to_address       | address | 数据使用方地址                  | Y        |

- 响应

  ```json
  {
      "status": 200,
      "result": {
          transaction_hash: "0xxxxxxxxxxxxxxxxxxxx"
      },
      "msg": "transfer NFT Ownership success."
  }
  ```

- 示例

  ```shell
  curl --request POST \
       --url 'http://datumtechs.com/api/v2/$contract_address/transferOwnership?chainId=$chainId&tokenid=$tokenid&to_address=$to_address' \
       --header 'Accept: application/json' \
       --header 'Content-Type: application/json' \
       --header 'X-API-Key: test'
  ```


### 使用权转移

用户在确定需要某个数据资产后，出于业务需求和资金考虑，只需要进行单次或一定期限内的查询或计算使用，在与提供方达成数据资产交易后，数据提供方可通过调用此API改变Data Token的使用方式属性，将该Data Token提供给购买用户。获得使用权的用户可以凭该Token访问、查看、在限定范围内计算或使用对应的原始数据，该原始数据可能是明文或者以隐私计算的方式提供使用。

#### 如何使用

- 接口名称：transferUsageRights

- 参数说明

  | 名称             | 类型    | 说明                            | 是否必填 |
  | ---------------- | ------- | ------------------------------- | -------- |
  | contract_address | address | NFT合约地址                     | Y        |
  | chainId          | uint32  | 链id，默认为1，表示ethereum主网 | N        |
  | tokenid          | string  | NFT的id                         | Y        |
  | to_address       | address | 数据使用方地址                  | Y        |

- 响应

  ```json
  {
      "status": 200,
      "result": {
          transaction_hash: "0xxxxxxxxxxxxxxxxxxxx"
      },
      "msg": "transfer NFT Usage Rights success."
  }
  ```

- 示例

  ```shell
  curl --request POST \
       --url 'http://datumtechs.com/api/v2/$contract_address/transferUsageRights?chainId=$chainId&tokenid=$tokenid&to_address=$to_address' \
       --header 'Accept: application/json' \
       --header 'Content-Type: application/json' \
       --header 'X-API-Key: test'
  ```


### 数据资产使用权限验证

数据持有方可调用此API验证数据使用方持有的Data Token对应的数据资产使用权限。


**如何使用**

- 接口名称：verifyAccess

- 参数说明

  | 名称             | 类型    | 说明                            | 是否必填 |
  | ---------------- | ------- | ------------------------------- | -------- |
  | contract_address | address | NFT合约地址                     | Y        |
  | chainId          | uint32  | 链id，默认为1，表示ethereum主网 | N        |
  | tokenid          | string  | NFT的id                         | Y        |
  | operate          | elem    | 1: 查看，2:下载                 | Y        |

- 响应

  ```json
  {
  	"status": 200,
  	"result": {
  		"token_address": "0x8df91a59b8610990004987ac6ad8b6e70779ee97",
  		"token_id": "1",
  		"owner_of": "0x806164c929ad3a6f4bd70c2370b3ef36c64deaa8",
  		"contract_type": "ERC721",
  		"name": "datum",
  		"symbol": "FZAI1",
          "operate": "view/download"
  	},
  	"msg": "Validation of access rights succeeded."
  }
  ```

- 示例

  ```shell
  curl --request POST \
       --url 'http://datumtechs.com/api/v2/$contract_address/verifyAccess?chainId=$chainId&tokenid=$tokenid&operate=$operate' \
       --header 'Accept: application/json' \
       --header 'Content-Type: application/json' \
       --header 'X-API-Key: test'
  ```


### 查看原始数据

用户可以根据权限查看Data NFT对应的原始数据。

**主要功能**

用户通过拥有查看权限的Data Token调用原始数据查看API接口，鉴权通过后，可以查看对应的原数据信息。对于托管存储方式的密文数据，需要先获得[访问明文数据权限](#访问明文数据前悬)，否则不能查看到明文数据。

**如何使用**

- 接口名称：getRawData

- 参数说明

  | 名称             | 类型    | 说明                                                         | 是否必填 |
  | ---------------- | ------- | ------------------------------------------------------------ | -------- |
  | contract_address | address | NFT合约地址                                                  | Y        |
  | chainId          | uint32  | 链id，默认为1，表示ethereum主网                              | N        |
  | tokenid          | string  | NFT的id                                                      | Y        |
  | publicKey        | string  | 用户公钥，原数据使用托管方式存储时需要传此参数；如已经授权，则不可以不传此参数 | N        |

- 响应

  ```json
  {
  	"status": 200,
  	"result": {
  		"token_address": "0x8df91a59b8610990004987ac6ad8b6e70779ee97",
  		"token_id": "1",
  		"owner_of": "0x806164c929ad3a6f4bd70c2370b3ef36c64deaa8",
  		"contract_type": "ERC721",
  		"name": "datum",
  		"symbol": "FZAI1",
          "file_hash": "0x.....................",
          "storage_method": "hosting/Unmanaged",
          "permission_type": "ownership/use", 
  		"metadata": "{
          	"name": "datum", 
          	"description": "this is datum metadata", 
          	"file_type": "csv",
          	"data_size": 100, 
              "columns": 2, 
              "rows": 10, 
              "cols_desc": [
                  {"col_name": "col1", "col_desc": "this is col1 desc"},
                  {"col_name": "col2", "col_desc": "this is col2 desc"}
  			]
  		}",
  		"content": "this is data content."
  	},
  	"msg": "get data success."
  }
  ```

- 示例

  ```shell
  curl --request POST \
       --url 'http://datumtechs.com/api/v2/$contract_address/getRawData?chainId=$chainId&tokenid=$tokenid&publicKey=$publicKey' \
       --header 'Accept: application/json' \
       --header 'Content-Type: application/json' \
       --header 'X-API-Key: test'
  ```

### 下载原始数据

用户可以根据权限下载Data NFT对应的原始数据。

**功能描述**

用户通过拥有下载权限的Data Token调用数据下载API接口，鉴权通过后，可以下载对应的原石数据；对于托管存储方式的密文数据，下载前需要先获得[访问明文数据权限](#访问明文数据权限)，否则不能下载明文数据。

**如何使用**

- 接口名称：downloadData

- 参数说明

  | 名称             | 类型    | 说明                                                         | 是否必填 |
  | ---------------- | ------- | ------------------------------------------------------------ | -------- |
  | contract_address | address | NFT合约地址                                                  | Y        |
  | chainId          | uint32  | 链id，默认为1，表示ethereum主网                              | N        |
  | tokenid          | string  | NFT的id                                                      | Y        |
  | publicKey        | string  | 用户公钥，原数据使用托管方式存储时需要传此参数；如已经授权，则不可以不传此参数 | N        |

- 响应

  ```json
  {
  	"status": 200,
  	"result": {
  		"token_address": "0x8df91a59b8610990004987ac6ad8b6e70779ee97",
  		"token_id": "1",
  		"owner_of": "0x806164c929ad3a6f4bd70c2370b3ef36c64deaa8",
  		"contract_type": "ERC721",
  		"name": "datum",
  		"symbol": "FZAI1",
          "file_type": "csv",
          "file_hash": "0x.....................",
          "storage_method": "hosting/Unmanaged",
          "permission_type": "ownership/use",        
  		"metadata": "{
          	"name": "datum", 
          	"description": "this is datum metadata", 
          	"data_size": 100, 
              "columns": 2, 
              "rows": 10, 
              "cols_desc": [
                  {"col_name": "col1", "col_desc": "this is col1 desc"},
                  {"col_name": "col2", "col_desc": "this is col2 desc"}
  			]
  		}",
  		"file_path": "/path/file.csv"
  	},
  	"msg": "download data file success."
  }
  ```

- 示例

  ```shell
  curl --request POST \
       --url 'http://datumtechs.com/api/v2/$contract_address/downloadData?chainId=$chainId&tokenid=$tokenid&publicKey=$publicKey' \
       --header 'Accept: application/json' \
       --header 'Content-Type: application/json' \
       --header 'X-API-Key: test'
  ```

### 代理重加密服务

Datum提供原始数据基于代理重加密算法的可信托管服务，确保原始数据在存托使用和鉴权时全程保持密文状态，且在确认使用方访问权限后提供对应查看密钥。

#### 重加密密钥生成

数据使用方申请[授权访问](#授权访问)时，数据提供方在接收到请求后，会调用api服务生成重加密密钥。

**功能描述**

数据提供方使用自己的私钥和数据提供方的公钥生成代理重加密密钥，然后将此重加密密钥发送给托管服务；托管服务使用重加密密钥不能解密数据。

**如何使用**

- 接口名称：genReEncryptKey

- 参数说明

  | 名称       | 类型   | 说明           | 是否必填 |
  | ---------- | ------ | -------------- | -------- |
  | privateKey | string | 数据提供方私钥 | Y        |
  | publicKey  | string | 数据使用方公钥 | Y        |

- 响应

  ```json
  {
  	"status": 200,
  	"result": {
          "Re-EncryptKey": "............."
      },
  	"msg": "Generate re-encryption key succeeded."
  }
  ```

- 示例

  ```shell
  curl --request POST \
       --url 'http://datumtechs.com/api/v2/$contract_address/genReEncryptKey?privateKey=$privateKey&publicKey=$publicKey' \
       --header 'Accept: application/json' \
       --header 'Content-Type: application/json' \
       --header 'X-API-Key: test'
  ```

#### 加密密钥转换

当用户持有Data Token申请密文数据查看或下载鉴权时，需调用此api向托管方申请实现加密密钥转换。

**功能描述**

托管服务使用代理重加密密钥对加密的数据进行密钥转换，生成数据使用方私钥可以解密的密文。

**如何使用**

- 接口名称：convertEncryptkey

- 参数说明

  | 名称         | 类型   | 说明                                 | 是否必填 |
  | ------------ | ------ | ------------------------------------ | -------- |
  | reEncryptKey | string | 代理重加密密钥                       | Y        |
  | CPKa         | string | 使用数据提供方公钥对数据加密后的数据 | Y        |

- 响应

  ```json
  {
  	"status": 200,
  	"result": {
          "CPKb": "..........."
      },
  	"msg": "Convert encryption keys succeeded."
  }
  ```

- 示例

  ```shell
  curl --request POST \
       --url 'http://datumtechs.com/api/v2/$contract_address/convertEncryptkey?reEncryptKey=$reEncryptKey&CPKa=$CPKa' \
       --header 'Accept: application/json' \
       --header 'Content-Type: application/json' \
       --header 'X-API-Key: test'
  ```


#### 授权访问明文数据

数据使用方持有的Data Token对应的原始数据以密文形式托管时，在申请访问使用前，需使用持有的Data Token和公钥调用此API接口，申请授权访问明文数据。

**如何使用**

- 接口名称：authAccessToRawData

- 参数说明

  | 名称             | 类型    | 说明                                                         | 是否必填 |
  | ---------------- | ------- | ------------------------------------------------------------ | -------- |
  | contract_address | address | NFT合约地址                                                  | Y        |
  | chainId          | uint32  | 链id，默认为1，表示ethereum主网                              | N        |
  | tokenid          | string  | NFT的id                                                      | Y        |
  | publicKey        | string  | 用户公钥，原数据使用托管方式存储时需要传此参数；如已经授权，则不可以不传此参数 | N        |

- 响应

  ```json
  {
  	"status": 200,
  	"result": {
  		"token_address": "0x8df91a59b8610990004987ac6ad8b6e70779ee97",
  		"token_id": "1",
  		"owner_of": "0x806164c929ad3a6f4bd70c2370b3ef36c64deaa8",
  		"contract_type": "ERC721",
  		"name": "datum",
  		"symbol": "FZAI1",
          "storage_method": "hosting/Unmanaged",
  	},
  	"msg": "Authorization to access plaintext data succeeded."
  }
  ```

- 示例

  ```shell
  curl --request POST \
       --url 'http://datumtechs.com/api/v2/$contract_address/downloadData?chainId=$chainId&tokenid=$tokenid&publicKey=$publicKey' \
       --header 'Accept: application/json' \
       --header 'Content-Type: application/json' \
       --header 'X-API-Key: test'
  ```



#### 访问明文数据权限验证

用户需要访问的数据是以密文形式存储在Datum提供的存托渠道中时，可以调用此API验证是否有明文访问权限；

**如何使用**

- 接口名称：verifyAccessRawData

- 参数说明

  | 名称             | 类型    | 说明                                                         | 是否必填 |
  | ---------------- | ------- | ------------------------------------------------------------ | -------- |
  | contract_address | address | NFT合约地址                                                  | Y        |
  | chainId          | uint32  | 链id，默认为1，表示ethereum主网                              | N        |
  | tokenid          | string  | NFT的id                                                      | Y        |
  | publicKey        | string  | 用户公钥，原数据使用托管方式存储时需要传此参数；如已经授权，则不可以不传此参数 | N        |

- 响应

  ```json
  {
  	"status": 200,
  	"result": {
  		"token_address": "0x8df91a59b8610990004987ac6ad8b6e70779ee97",
  		"token_id": "1",
  		"owner_of": "0x806164c929ad3a6f4bd70c2370b3ef36c64deaa8",
  		"contract_type": "ERC721",
  		"name": "datum",
  		"symbol": "FZAI1",
          "storage_method": "hosting/Unmanaged",
          "publicKey": "0x......................."
  	},
  	"msg": "Verifying access to plaintext data is successful."
  }
  ```

- 示例

  ```shell
  curl --request POST \
       --url 'http://datumtechs.com/api/v2/$contract_address/verifyAccessRawData?chainId=$chainId&tokenid=$tokenid&publicKey=$publicKey' \
       --header 'Accept: application/json' \
       --header 'Content-Type: application/json' \
       --header 'X-API-Key: test'
  ```

### 数据一致性验证

为了保证用户下载的数据和数据提供方提供的数据是一致的，用户在下载完数据之后可以进行一致性的验证；同时用户也可以在使用原始数据文件时，调用API验证一致性。

- 数据下载完成之后，用户可以调用此API验证数据的一致性（内部调用）。
- 使用数据文件之前，调用此API验证数据文件的一致性（外部调用）。


**如何使用**

- 接口名称：verifyDataIntegrity

- 参数说明

  | 名称             | 类型    | 说明                            | 是否必填 |
  | ---------------- | ------- | ------------------------------- | -------- |
  | contract_address | address | NFT合约地址                     | Y        |
  | chainId          | uint32  | 链id，默认为1，表示ethereum主网 | N        |
  | tokenid          | string  | NFT的id                         | Y        |
  | path             | string  | 数据文件路径                    | N        |

- 响应

  ```json
  {
  	"status": 200,
  	"result": {
  		"token_address": "0x8df91a59b8610990004987ac6ad8b6e70779ee97",
  		"token_id": "1",
  		"owner_of": "0x806164c929ad3a6f4bd70c2370b3ef36c64deaa8",
  		"contract_type": "ERC721",
  		"name": "datum",
  		"symbol": "FZAI1",
          "file_hash": "0x.....................",
          "storage_method": "hosting/Unmanaged",
          "publicKey": "0x......................."
  	},
  	"msg": "Verify data consistency is successful."
  }
  ```

- 示例

  ```shell
  curl --request POST \
       --url 'http://datumtechs.com/api/v2/$contract_address/verifyDataIntegrity?chainId=$chainId&tokenid=$tokenid&path=$path' \
       --header 'Accept: application/json' \
       --header 'Content-Type: application/json' \
       --header 'X-API-Key: test'
  ```
  
