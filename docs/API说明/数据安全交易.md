
## 基于Token属性的鉴权访问

### 元数据查看

用户可以先通过查看已发布的元数据确定原始数据情况，判断是否需要购买对应的Data Token; 用户可调用元数据查看API接口，在链上或数据服务平台上发起查询，此调用过程不需要鉴权。

**如何使用**

- 接口名称：getMetaData
- 参数说明

  | 名称             | 类型    | 说明                            | 是否必填 |
  | ---------------- | ------- | ------------------------------- | -------- |
  | contract_address | address | NFT合约地址                     | Y        |
  | chainId          | uint32  | 链id，默认为1，表示ethereum主网 | N        |
  | tokenid          | string  | NFT的id                         | Y        |

- 响应

  ```json
  {
  	"status": 200,
  	"result": {
  		"token_address": "0x8df91a59b8610990004987ac6ad8b6e70779ee97",
  		"token_id": "1",
  		"owner_of": "0x806164c929ad3a6f4bd70c2370b3ef36c64deaa8",
  		"contract_type": "ERC721",
  		"name": "datum",
  		"symbol": "FZAI1",
          "file_hash": "0x.....................",
          "storage_method": "hosting/Unmanaged",
          "permission_type": "ownership/use", 
  		"metadata": "{
          	"name": "datum", 
          	"description": "this is datum metadata", 
          	"data_size": 100, 
              "columns": 2, 
              "rows": 10, 
              "cols_desc": [
                  {"col_name": "col1", "col_desc": "this is col1 desc"},
                  {"col_name": "col2", "col_desc": "this is col2 desc"}
  			]
  		}"
  	},
  	"msg": "get MetaData success."
  }
  ```

- 示例

  ```shell
  curl --request POST \
       --url 'http://datumtechs.com/api/v2/$contract_address/getMetaData?chainId=$chainId&tokenid=$tokenid' \
       --header 'Accept: application/json' \
       --header 'Content-Type: application/json' \
       --header 'X-API-Key: test'
  ```

### 原始数据查看

用户可以根据权限查看Data NFT对应的原始数据。

**主要功能**

用户通过拥有查看权限的Data Token调用原始数据查看API接口，鉴权通过后，可以查看对应的原数据信息。对于托管存储方式的密文数据，需要先[申请访问明文数据权限](#申请访问明文数据权限)，否则不能查看到明文数据。

**如何使用**

- 接口名称：getRawData

- 参数说明

  | 名称             | 类型    | 说明                                                         | 是否必填 |
  | ---------------- | ------- | ------------------------------------------------------------ | -------- |
  | contract_address | address | NFT合约地址                                                  | Y        |
  | chainId          | uint32  | 链id，默认为1，表示ethereum主网                              | N        |
  | tokenid          | string  | NFT的id                                                      | Y        |
  | publicKey        | string  | 用户公钥，原数据使用托管方式存储时需要传此参数；如已经授权，则不可以不传此参数 | N        |

- 响应

  ```json
  {
  	"status": 200,
  	"result": {
  		"token_address": "0x8df91a59b8610990004987ac6ad8b6e70779ee97",
  		"token_id": "1",
  		"owner_of": "0x806164c929ad3a6f4bd70c2370b3ef36c64deaa8",
  		"contract_type": "ERC721",
  		"name": "datum",
  		"symbol": "FZAI1",
          "file_hash": "0x.....................",
          "storage_method": "hosting/Unmanaged",
          "permission_type": "ownership/use", 
  		"metadata": "{
          	"name": "datum", 
          	"description": "this is datum metadata", 
          	"file_type": "csv",
          	"data_size": 100, 
              "columns": 2, 
              "rows": 10, 
              "cols_desc": [
                  {"col_name": "col1", "col_desc": "this is col1 desc"},
                  {"col_name": "col2", "col_desc": "this is col2 desc"}
  			]
  		}",
  		"content": "this is data content."
  	},
  	"msg": "get data success."
  }
  ```

- 示例

  ```shell
  curl --request POST \
       --url 'http://datumtechs.com/api/v2/$contract_address/getRawData?chainId=$chainId&tokenid=$tokenid&publicKey=$publicKey' \
       --header 'Accept: application/json' \
       --header 'Content-Type: application/json' \
       --header 'X-API-Key: test'
  ```

## 基于Token属性的安全分享

### 所有权转移

用户在确定需要某个数据资产后，与提供方达成数据资产交易买卖后，数据提供方可通过调用此API改变Data Token的所有权属性，将该Data Token转移给购买用户。获得所有权的用户可以凭该Token访问、查看、下载对应的原始数据。


**如何使用**

- 接口名称：transferOwnership

- 参数说明

  | 名称             | 类型    | 说明                            | 是否必填 |
  | ---------------- | ------- | ------------------------------- | -------- |
  | contract_address | address | NFT合约地址                     | Y        |
  | chainId          | uint32  | 链id，默认为1，表示ethereum主网 | N        |
  | tokenid          | string  | NFT的id                         | Y        |
  | to_address       | address | 数据使用方地址                  | Y        |

- 响应

  ```json
  {
      "status": 200,
      "result": {
          transaction_hash: "0xxxxxxxxxxxxxxxxxxxx"
      },
      "msg": "transfer NFT Ownership success."
  }
  ```

- 示例

  ```shell
  curl --request POST \
       --url 'http://datumtechs.com/api/v2/$contract_address/transferOwnership?chainId=$chainId&tokenid=$tokenid&to_address=$to_address' \
       --header 'Accept: application/json' \
       --header 'Content-Type: application/json' \
       --header 'X-API-Key: test'
  ```


### 使用权转移

用户在确定需要某个数据资产后，出于业务需求和资金考虑，只需要进行单次或一定期限内的查询或计算使用，在与提供方达成数据资产交易后，数据提供方可通过调用此API改变Data Token的使用方式属性，将该Data Token提供给购买用户。获得使用权的用户可以凭该Token访问、查看、在限定范围内计算或使用对应的原始数据，该原始数据可能是明文或者以隐私计算的方式提供使用。

**如何使用**

- 接口名称：transferUsageRights

- 参数说明

  | 名称             | 类型    | 说明                            | 是否必填 |
  | ---------------- | ------- | ------------------------------- | -------- |
  | contract_address | address | NFT合约地址                     | Y        |
  | chainId          | uint32  | 链id，默认为1，表示ethereum主网 | N        |
  | tokenid          | string  | NFT的id                         | Y        |
  | to_address       | address | 数据使用方地址                  | Y        |

- 响应

  ```json
  {
      "status": 200,
      "result": {
          transaction_hash: "0xxxxxxxxxxxxxxxxxxxx"
      },
      "msg": "transfer NFT Usage Rights success."
  }
  ```

- 示例

  ```shell
  curl --request POST \
       --url 'http://datumtechs.com/api/v2/$contract_address/transferUsageRights?chainId=$chainId&tokenid=$tokenid&to_address=$to_address' \
       --header 'Accept: application/json' \
       --header 'Content-Type: application/json' \
       --header 'X-API-Key: test'
  ```


### 数据资产使用权限验证

数据持有方可调用此API验证数据使用方持有的Data Token对应的数据资产使用权限。


**如何使用**

- 接口名称：verifyAccess

- 参数说明

  | 名称             | 类型    | 说明                            | 是否必填 |
  | ---------------- | ------- | ------------------------------- | -------- |
  | contract_address | address | NFT合约地址                     | Y        |
  | chainId          | uint32  | 链id，默认为1，表示ethereum主网 | N        |
  | tokenid          | string  | NFT的id                         | Y        |
  | operate          | elem    | 1: 查看，2:下载                 | Y        |

- 响应

  ```json
  {
  	"status": 200,
  	"result": {
  		"token_address": "0x8df91a59b8610990004987ac6ad8b6e70779ee97",
  		"token_id": "1",
  		"owner_of": "0x806164c929ad3a6f4bd70c2370b3ef36c64deaa8",
  		"contract_type": "ERC721",
  		"name": "datum",
  		"symbol": "FZAI1",
          "operate": "view/download"
  	},
  	"msg": "Validation of access rights succeeded."
  }
  ```

- 示例

  ```shell
  curl --request POST \
       --url 'http://datumtechs.com/api/v2/$contract_address/verifyAccess?chainId=$chainId&tokenid=$tokenid&operate=$operate' \
       --header 'Accept: application/json' \
       --header 'Content-Type: application/json' \
       --header 'X-API-Key: test'
  ```

### 原始数据下载

用户可以根据权限下载Data NFT对应的原始数据。

**功能描述**

用户通过拥有下载权限的Data Token调用数据下载API接口，鉴权通过后，可以下载对应的原石数据；对于托管存储方式的密文数据，下载前需要先[申请访问明文数据权限](#申请访问明文数据权限)，否则不能下载明文数据。

**如何使用**

- 接口名称：downloadData

- 参数说明

  | 名称             | 类型    | 说明                                                         | 是否必填 |
  | ---------------- | ------- | ------------------------------------------------------------ | -------- |
  | contract_address | address | NFT合约地址                                                  | Y        |
  | chainId          | uint32  | 链id，默认为1，表示ethereum主网                              | N        |
  | tokenid          | string  | NFT的id                                                      | Y        |
  | publicKey        | string  | 用户公钥，原数据使用托管方式存储时需要传此参数；如已经授权，则不可以不传此参数 | N        |

- 响应

  ```json
  {
  	"status": 200,
  	"result": {
  		"token_address": "0x8df91a59b8610990004987ac6ad8b6e70779ee97",
  		"token_id": "1",
  		"owner_of": "0x806164c929ad3a6f4bd70c2370b3ef36c64deaa8",
  		"contract_type": "ERC721",
  		"name": "datum",
  		"symbol": "FZAI1",
          "file_type": "csv",
          "file_hash": "0x.....................",
          "storage_method": "hosting/Unmanaged",
          "permission_type": "ownership/use",        
  		"metadata": "{
          	"name": "datum", 
          	"description": "this is datum metadata", 
          	"data_size": 100, 
              "columns": 2, 
              "rows": 10, 
              "cols_desc": [
                  {"col_name": "col1", "col_desc": "this is col1 desc"},
                  {"col_name": "col2", "col_desc": "this is col2 desc"}
  			]
  		}",
  		"file_path": "/path/file.csv"
  	},
  	"msg": "download data file success."
  }
  ```

- 示例

  ```shell
  curl --request POST \
       --url 'http://datumtechs.com/api/v2/$contract_address/downloadData?chainId=$chainId&tokenid=$tokenid&publicKey=$publicKey' \
       --header 'Accept: application/json' \
       --header 'Content-Type: application/json' \
       --header 'X-API-Key: test'
  ```


### 申请访问明文数据权限

数据使用方持有的Data Token对应的原始数据以密文形式托管时，需使用持有的Data Token和公钥调用此API接口，申请授权访问明文数据权限。

**如何使用**

- 接口名称：RequestAccessToRawData

- 参数说明

  | 名称             | 类型    | 说明                                                         | 是否必填 |
  | ---------------- | ------- | ------------------------------------------------------------ | -------- |
  | contract_address | address | NFT合约地址                                                  | Y        |
  | chainId          | uint32  | 链id，默认为1，表示ethereum主网                              | N        |
  | tokenid          | string  | NFT的id                                                      | Y        |
  | publicKey        | string  | 用户公钥，原数据使用托管方式存储时需要传此参数；如已经授权，则不可以不传此参数 | N        |

- 响应

  ```json
  {
  	"status": 200,
  	"result": {
  		"token_address": "0x8df91a59b8610990004987ac6ad8b6e70779ee97",
  		"token_id": "1",
  		"owner_of": "0x806164c929ad3a6f4bd70c2370b3ef36c64deaa8",
  		"contract_type": "ERC721",
  		"name": "datum",
  		"symbol": "FZAI1",
          "storage_method": "hosting/Unmanaged",
  	},
  	"msg": "Authorization to access plaintext data succeeded."
  }
  ```

- 示例

  ```shell
  curl --request POST \
       --url 'http://datumtechs.com/api/v2/$contract_address/RequestAccessToRawData?chainId=$chainId&tokenid=$tokenid&publicKey=$publicKey' \
       --header 'Accept: application/json' \
       --header 'Content-Type: application/json' \
       --header 'X-API-Key: test'
  ```



### 访问明文数据权限验证

用户需要访问的数据是以密文形式存储在Datum提供的存托渠道中时，可以调用此API验证是否有明文访问权限；

**如何使用**

- 接口名称：verifyAccessRawData

- 参数说明

  | 名称             | 类型    | 说明                                                         | 是否必填 |
  | ---------------- | ------- | ------------------------------------------------------------ | -------- |
  | contract_address | address | NFT合约地址                                                  | Y        |
  | chainId          | uint32  | 链id，默认为1，表示ethereum主网                              | N        |
  | tokenid          | string  | NFT的id                                                      | Y        |
  | publicKey        | string  | 用户公钥，原数据使用托管方式存储时需要传此参数；如已经授权，则不可以不传此参数 | N        |

- 响应

  ```json
  {
  	"status": 200,
  	"result": {
  		"token_address": "0x8df91a59b8610990004987ac6ad8b6e70779ee97",
  		"token_id": "1",
  		"owner_of": "0x806164c929ad3a6f4bd70c2370b3ef36c64deaa8",
  		"contract_type": "ERC721",
  		"name": "datum",
  		"symbol": "FZAI1",
          "storage_method": "hosting/Unmanaged",
          "publicKey": "0x......................."
  	},
  	"msg": "Verifying access to plaintext data is successful."
  }
  ```

- 示例

  ```shell
  curl --request POST \
       --url 'http://datumtechs.com/api/v2/$contract_address/verifyAccessRawData?chainId=$chainId&tokenid=$tokenid&publicKey=$publicKey' \
       --header 'Accept: application/json' \
       --header 'Content-Type: application/json' \
       --header 'X-API-Key: test'
  ```



## Token使用后的结算处理

用户在使用Token完成对数据的操作后，服务会进行确认Token的使用，然后修改Token的操作属性并上链，如：修改使用后的Token的操作次数，或设置为冻结/销毁状态，此类属性都将作为是否有操作权限的判定标准。

### 确认使用

用户在使用Token发起操作时，如原数据下载，服务记录并确认Token的使用情况。

**如何使用**

- 接口名称：confirmToUse

- 参数说明

  | 名称             | 类型    | 说明                            | 是否必填 |
  | ---------------- | ------- | ------------------------------- | -------- |
  | contract_address | address | NFT合约地址                     | Y        |
  | chainId          | uint32  | 链id，默认为1，表示ethereum主网 | N        |
  | tokenid          | string  | NFT的id                         | Y        |

- 响应

  ```json
  {
  	"status": 200,
  	"result": {
  		"token_address": "0x8df91a59b8610990004987ac6ad8b6e70779ee97",
  		"token_id": "1",
  		"owner_of": "0x806164c929ad3a6f4bd70c2370b3ef36c64deaa8",
  		"contract_type": "ERC721",
  		"name": "datum",
  		"symbol": "FZAI1",
          "storage_method": "hosting/Unmanaged",
          "publicKey": "0x......................."
  	},
  	"msg": "Token confirm to use."
  }
  ```

- 示例

  ```shell
  curl --request POST \
       --url 'http://datumtechs.com/api/v2/$contract_address/confirmToUse?chainId=$chainId&tokenid=$tokenid' \
       --header 'Accept: application/json' \
       --header 'Content-Type: application/json' \
       --header 'X-API-Key: test'
  ```

### 使用后冻结/销毁

用户在使用Token完成操作后，如原数据下载，服务通过修改Token的操作属性来冻结/销毁被使用的Token。

**如何使用**

- 接口名称：destroyOrFreezeToken

- 参数说明

  | 名称             | 类型    | 说明                            | 是否必填 |
  | ---------------- | ------- | ------------------------------- | -------- |
  | contract_address | address | NFT合约地址                     | Y        |
  | chainId          | uint32  | 链id，默认为1，表示ethereum主网 | N        |
  | tokenid          | string  | NFT的id                         | Y        |
  | option           | uint8   | 修改操作状态，0:冻结；1:销毁    | Y        |

- 响应

  ```json
  {
  	"status": 200,
  	"result": {
  		"token_address": "0x8df91a59b8610990004987ac6ad8b6e70779ee97",
  		"token_id": "1",
  		"owner_of": "0x806164c929ad3a6f4bd70c2370b3ef36c64deaa8",
  		"contract_type": "ERC721",
  		"name": "datum",
  		"symbol": "FZAI1",
          "storage_method": "hosting/Unmanaged",
          "publicKey": "0x......................."
  	},
  	"msg": "Token confirm to use."
  }
  ```

- 示例

  ```bash
  curl --request POST \
       --url 'http://datumtechs.com/api/v2/$contract_address/destroyOrFreezeToken?chainId=$chainId&tokenid=$tokenid&option=$option' \
       --header 'Accept: application/json' \
       --header 'Content-Type: application/json' \
       --header 'X-API-Key: test'
  ```
